<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receta M√©dica - MediTrack</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 2rem;
        }

        .header p {
            color: #666;
            font-size: 0.9rem;
        }

        .section-title {
            color: #667eea;
            font-size: 1.2rem;
            margin: 25px 0 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .info-value {
            color: #666;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .medicamentos-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .medicamentos-table thead {
            background: #667eea;
            color: white;
        }

        .medicamentos-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .medicamentos-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .medicamentos-table tbody tr:hover {
            background: #f9f9f9;
        }

        .btn-agregar {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .btn-agregar:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .btn-eliminar {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-eliminar:hover {
            background: #ff5252;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-back {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: #667eea;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideDown 0.3s;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .required::after {
            content: " *";
            color: red;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nota {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 20px;
            color: #555;
            font-size: 0.9rem;
        }

        .form-group {
            position: relative;
        }

        @media (max-width: 768px) {
            .form-row,
            .info-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }

            .medicamentos-table {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíä Receta M√©dica</h1>
            <p>Emisi√≥n de prescripci√≥n m√©dica electr√≥nica</p>
        </div>

        <div id="alert-container"></div>

        <form id="formReceta">
        <!-- INFORMACI√ìN DEL M√âDICO -->
            <h2 class="section-title">Informaci√≥n del M√©dico</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">M√©dico</div>
                    <div class="info-value" id="medico-nombre">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Especialidad</div>
                    <div class="info-value" id="medico-especialidad">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">N√∫mero Colegiado</div>
                    <div class="info-value" id="medico-colegiado">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Instituci√≥n</div>
                    <div class="info-value" id="medico-institucion">-</div>
                </div>
            </div>

            <!-- Input Hidden para id_medico -->
            <input type="hidden" id="id_medico" value="">

            <!-- INFORMACI√ìN DEL PACIENTE -->
            <h2 class="section-title">Informaci√≥n del Paciente</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Paciente</div>
                    <div class="info-value" id="paciente-nombre">Seleccionar paciente</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Identificaci√≥n</div>
                    <div class="info-value" id="paciente-id">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Grupo Sangu√≠neo</div>
                    <div class="info-value" id="paciente-sangre">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Alergias</div>
                    <div class="info-value" id="paciente-alergias">-</div>
                </div>
            </div>

            <div class="form-group" style="position: relative;">
                <label class="required">Buscar Paciente</label>
                <input 
                    type="text" 
                    id="buscar-paciente" 
                    placeholder="Ingrese nombre o identificaci√≥n del paciente..."
                    required
                    autocomplete="off"
                >
                <input type="hidden" id="id_paciente" value="">
                <div id="lista-pacientes" style="
                    display: none;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 2px solid #667eea;
                    border-top: none;
                    border-radius: 0 0 8px 8px;
                    max-height: 250px;
                    overflow-y: auto;
                    z-index: 100;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                ">
                </div>
            </div>

            <!-- DIAGN√ìSTICO -->
            <h2 class="section-title">Diagn√≥stico</h2>
            <div class="form-group">
                <label class="required">Diagn√≥stico</label>
                <textarea id="diagnostico" rows="4" required placeholder="Describa el diagn√≥stico del paciente..."></textarea>
            </div>

            <!-- MEDICAMENTOS -->
            <h2 class="section-title">Medicamentos Prescritos</h2>
            
            <table class="medicamentos-table" id="tablaMedicamentos">
                <thead>
                    <tr>
                        <th>Medicamento</th>
                        <th>Dosis</th>
                        <th>Frecuencia</th>
                        <th>Duraci√≥n (d√≠as)</th>
                        <th>V√≠a Administrativa</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="medicamentos-body">
                    <!-- Se agregan din√°micamente -->
                </tbody>
            </table>

            <button type="button" class="btn-agregar" onclick="agregarMedicamento()">+ Agregar Medicamento</button>

            <!-- INSTRUCCIONES -->
            <h2 class="section-title">Instrucciones Especiales</h2>
            <div class="form-group">
                <label>Instrucciones para el paciente</label>
                <textarea id="instrucciones" rows="4" placeholder="Ej: Tomar con alimentos, evitar alcohol, etc..."></textarea>
            </div>

            <!-- FECHA -->
            <div class="form-row">
                <div class="form-group">
                    <label class="required">Fecha de Emisi√≥n</label>
                    <input type="date" id="fecha_emision" required>
                </div>
                <div class="form-group">
                    <label class="required">Vigencia (d√≠as)</label>
                    <input type="number" id="vigencia" min="1" max="180" value="30" required>
                </div>
            </div>

            <div class="nota">
                üìå <strong>Nota:</strong> Esta receta es v√°lida por el per√≠odo especificado. El paciente debe presentarla en la farmacia. Los medicamentos con receta requerida deben ser dispensados bajo supervisi√≥n.
            </div>

            <button type="submit" class="btn-submit" id="btnSubmit">
                Emitir Receta M√©dica
            </button>

            <a href="/dashboard/medico/" class="btn-back">‚Üê Volver al Dashboard</a>
        </form>
    </div>

    <!-- Modal para agregar medicamento -->
    <div id="modalMedicamento" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 50px auto; padding: 30px; max-width: 500px; border-radius: 15px;">
            <h3 style="margin-bottom: 20px; color: #667eea;">Agregar Medicamento</h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Medicamento</label>
                <select id="medicamento-select" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="">-- Seleccione --</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Dosis</label>
                <input type="text" id="medicamento-dosis" placeholder="Ej: 500mg" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Frecuencia</label>
                <input type="text" id="medicamento-frecuencia" placeholder="Ej: 3 veces al d√≠a" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Duraci√≥n (d√≠as)</label>
                <input type="number" id="medicamento-duracion" min="1" placeholder="30" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">V√≠a de Administraci√≥n</label>
                <select id="medicamento-via" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <option value="">-- Seleccione --</option>
                    <option value="oral">Oral</option>
                    <option value="intravenosa">Intravenosa</option>
                    <option value="intramuscular">Intramuscular</option>
                    <option value="topica">T√≥pica</option>
                    <option value="inhalatoria">Inhalatoria</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button type="button" onclick="guardarMedicamento()" style="background: #667eea; color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Guardar</button>
                <button type="button" onclick="cerrarModal()" style="background: #ccc; color: #333; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let medicamentosAgregados = [];
        let pacientes = [];
        let medicoActual = null;

        // Cargar m√©dico logueado
        function cargarMedicoLogueado() {
            try {
                const userData = sessionStorage.getItem('meditrack_usuario');
                const datosAdicionales = JSON.parse(sessionStorage.getItem('meditrack_datos') || '{}');

                if (!userData) {
                    alert('Debes iniciar sesi√≥n como m√©dico');
                    window.location.href = '/login/';
                    return;
                }

                const usuario = JSON.parse(userData);
                medicoActual = datosAdicionales;

                // Validar que sea m√©dico
                if (usuario.tipo_usuario !== 'medico') {
                    alert('Solo los m√©dicos pueden crear recetas');
                    window.location.href = '/login/';
                    return;
                }

                // Auto-llenar datos del m√©dico
                document.getElementById('medico-nombre').textContent = `Dr. ${usuario.nombre} ${usuario.apellido}`;
                document.getElementById('medico-especialidad').textContent = datosAdicionales.especialidad || '-';
                document.getElementById('medico-colegiado').textContent = datosAdicionales.numero_colegiado || '-';
                document.getElementById('medico-institucion').textContent = datosAdicionales.institucion || '-';
                document.getElementById('id_medico').value = datosAdicionales.id_medico || '';

                console.log('M√©dico cargado:', datosAdicionales);

            } catch (error) {
                console.error('Error cargando m√©dico:', error);
                alert('Error al cargar tus datos');
            }
        }

        // Cargar todos los pacientes
        async function cargarPacientes() {
            try {
                const response = await fetch('/api/paciente/listar/');
                const data = await response.json();
                
                // Manejar respuesta paginada o array directo
                pacientes = Array.isArray(data) ? data : (data.results || []);
                
                console.log('Pacientes cargados:', pacientes);
                
                // Agregar event listener al buscador despu√©s de cargar pacientes
                agregarEventListenerBuscador();
            } catch (error) {
                console.error('Error cargando pacientes:', error);
                alert('Error al cargar pacientes');
            }
        }

        // Event listener del buscador din√°mico
        function agregarEventListenerBuscador() {
            const inputBuscar = document.getElementById('buscar-paciente');
            const listaDiv = document.getElementById('lista-pacientes');

            if (!inputBuscar) {
                console.error('Input de b√∫squeda no encontrado');
                return;
            }

            inputBuscar.addEventListener('input', async function() {
                const texto = this.value.toLowerCase().trim();

                if (texto.length < 2) {
                    listaDiv.style.display = 'none';
                    return;
                }

                let candidatos = pacientes;

                // Si tenemos muchos pacientes o preferimos b√∫squeda en servidor, usar el endpoint de b√∫squeda
                if (texto.length >= 3) {
                    try {
                        const resp = await fetch(`/api/paciente/buscar/?q=${encodeURIComponent(texto)}`);
                        const json = await resp.json();
                        console.log('Respuesta buscar pacientes:', json);
                        candidatos = Array.isArray(json) ? json : (json.results || []);
                        console.log('Candidatos recibidos (servidor):', candidatos.length);
                    } catch (err) {
                        console.error('Error buscando pacientes en servidor:', err);
                    }
                }

                // Filtrar pacientes localmente sobre candidatos
                const pacientesFiltrados = (candidatos || []).filter(p => {
                    const usuario = p.id_usuario || p.usuario || {};
                    const nombre = (p.nombre_completo || `${usuario.nombre || ''} ${usuario.apellido || ''}`).toLowerCase();
                    const identificacion = (p.numero_identificacion || '').toLowerCase();
                    return nombre.includes(texto) || identificacion.includes(texto);
                });

                console.log('Pacientes filtrados (local):', pacientesFiltrados.length, pacientesFiltrados.slice(0,3));

                // Mostrar resultados
                if (pacientesFiltrados.length === 0) {
                    listaDiv.innerHTML = '<div style="padding: 10px; color: #999;">No se encontraron pacientes</div>';
                    listaDiv.style.display = 'block';
                    return;
                }

                listaDiv.innerHTML = pacientesFiltrados.map(p => {
                    const usuario = p.id_usuario || p.usuario || {};
                    return `
                        <div onclick="seleccionarPaciente(${p.id_paciente})" style="
                            padding: 12px;
                            cursor: pointer;
                            border-bottom: 1px solid #eee;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='white'">
                            <strong>${p.nombre_completo || `${usuario.nombre || ''} ${usuario.apellido || ''}`}</strong><br>
                            <small style="color: #666;">ID: ${p.numero_identificacion || 'N/A'}</small>
                        </div>
                    `;
                }).join('');

                listaDiv.style.display = 'block';
            });

            // Cerrar lista al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group')) {
                    listaDiv.style.display = 'none';
                }
            });
        }

        // Seleccionar paciente de la lista
        function seleccionarPaciente(pacienteId) {
            const paciente = pacientes.find(p => p.id_paciente === pacienteId);
            if (!paciente) {
                console.error('Paciente no encontrado en array local:', pacienteId);
                // Si no est√° en el array local, cargar directamente desde el servidor
                cargarPacienteDetalle(pacienteId);
                return;
            }

            mostrarPacienteSeleccionado(paciente);
        }

        // Cargar datos detallados de un paciente desde el servidor
        async function cargarPacienteDetalle(pacienteId) {
            try {
                const response = await fetch(`/api/pacientes/${pacienteId}/`);
                if (!response.ok) {
                    console.error('Error al obtener paciente:', response.status);
                    alert('Error al cargar los datos del paciente');
                    return;
                }
                const paciente = await response.json();
                mostrarPacienteSeleccionado(paciente);
            } catch (error) {
                console.error('Error cargando paciente detalle:', error);
                alert('Error al cargar los datos del paciente');
            }
        }

        // Mostrar datos del paciente seleccionado
        function mostrarPacienteSeleccionado(paciente) {
            // Manejar ambas estructuras de datos
            const usuario = paciente.id_usuario || paciente.usuario || {};
            const nombrePaciente = paciente.nombre_completo || `${usuario.nombre || ''} ${usuario.apellido || ''}`;

            console.log('Paciente seleccionado:', paciente);

            document.getElementById('id_paciente').value = paciente.id_paciente;
            document.getElementById('buscar-paciente').value = nombrePaciente;
            document.getElementById('lista-pacientes').style.display = 'none';

            // Mostrar datos del paciente
            document.getElementById('paciente-nombre').textContent = nombrePaciente;
            document.getElementById('paciente-id').textContent = paciente.numero_identificacion || '-';
            document.getElementById('paciente-sangre').textContent = paciente.grupo_sanguineo || '-';
            document.getElementById('paciente-alergias').textContent = paciente.alergias || 'Ninguna registrada';
        }

        // Cargar medicamentos
        async function cargarMedicamentos() {
            try {
                const response = await fetch('/api/medicamentos/');
                const data = await response.json();
                const medicamentos = data.results || data;
                
                const select = document.getElementById('medicamento-select');
                medicamentos.forEach(med => {
                    const option = document.createElement('option');
                    option.value = med.id_medicamento;
                    option.textContent = `${med.nombre_comercial} (${med.nombre_generico})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando medicamentos:', error);
            }
        }

        function agregarMedicamento() {
            document.getElementById('modalMedicamento').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalMedicamento').style.display = 'none';
            document.getElementById('medicamento-dosis').value = '';
            document.getElementById('medicamento-frecuencia').value = '';
            document.getElementById('medicamento-duracion').value = '';
            document.getElementById('medicamento-via').value = '';
        }

        function guardarMedicamento() {
            const select = document.getElementById('medicamento-select');
            const medicamentoId = select.value;
            const medicamentoNombre = select.options[select.selectedIndex].text;
            const dosis = document.getElementById('medicamento-dosis').value;
            const frecuencia = document.getElementById('medicamento-frecuencia').value;
            const duracion = document.getElementById('medicamento-duracion').value;
            const via = document.getElementById('medicamento-via').value;

            if (!medicamentoId || !dosis || !frecuencia || !duracion || !via) {
                alert('Por favor completa todos los campos');
                return;
            }

            medicamentosAgregados.push({
                id_medicamento: medicamentoId,
                nombre: medicamentoNombre,
                dosis,
                frecuencia,
                duracion_dias: duracion,
                via_administracion: via
            });

            actualizarTablaMedicamentos();
            cerrarModal();
        }

        function actualizarTablaMedicamentos() {
            const tbody = document.getElementById('medicamentos-body');
            tbody.innerHTML = '';

            medicamentosAgregados.forEach((med, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${med.nombre}</td>
                    <td>${med.dosis}</td>
                    <td>${med.frecuencia}</td>
                    <td>${med.duracion_dias}</td>
                    <td>${med.via_administracion}</td>
                    <td><button type="button" class="btn-eliminar" onclick="eliminarMedicamento(${index})">Eliminar</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminarMedicamento(index) {
            medicamentosAgregados.splice(index, 1);
            actualizarTablaMedicamentos();
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        document.getElementById('formReceta').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!document.getElementById('id_paciente').value) {
                showAlert('‚ùå Debes seleccionar un paciente', 'error');
                return;
            }

            if (medicamentosAgregados.length === 0) {
                showAlert('‚ùå Debe agregar al menos un medicamento', 'error');
                return;
            }

            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="loading"></span>Emitiendo...';

            const data = {
                id_medico: document.getElementById('id_medico').value,
                id_paciente: document.getElementById('id_paciente').value,
                diagnostico: document.getElementById('diagnostico').value,
                instrucciones: document.getElementById('instrucciones').value,
                fecha_emision: document.getElementById('fecha_emision').value,
                vigencia_dias: parseInt(document.getElementById('vigencia').value),
                medicamentos: medicamentosAgregados
            };

            try {
                const response = await fetch('/api/receta/crear/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('‚úÖ Receta m√©dica emitida correctamente', 'success');
                    document.getElementById('formReceta').reset();
                    medicamentosAgregados = [];
                    actualizarTablaMedicamentos();

                    setTimeout(() => {
                        window.location.href = '/dashboard/medico/';
                    }, 3000);
                } else {
                    showAlert(`‚ùå Error: ${result.error || 'No se pudo emitir la receta'}`, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showAlert('‚ùå Error al emitir la receta', 'error');
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = 'Emitir Receta M√©dica';
            }
        });

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            cargarMedicoLogueado();
            cargarPacientes();
            cargarMedicamentos();
            
            // Establecer fecha actual
            document.getElementById('fecha_emision').valueAsDate = new Date();
        });
    </script>
</body>
</html>
